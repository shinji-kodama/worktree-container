# 機能仕様書: Worktree Container CLI

**フィーチャーブランチ**: `001-worktree-container-cli`
**作成日**: 2026-02-28
**ステータス**: ドラフト
**入力**: Git ワークツリーごとに独立した Dev Container 環境を自動構築し、ポート衝突を完全に排除する CLI ツール。Homebrew でインストール可能。VS Code Dev Container、Dev Container CLI、DevPod に対応。

## 明確化事項

### セッション 2026-02-28

- Q: ポート割り当て状態の永続化方式は？ → A: Docker コンテナのラベル/メタデータから動的に検出（外部状態ファイル不要）
- Q: 元の devcontainer.json の扱いは？ → A: 元ファイルは読み取り専用。ワークツリー側にコピーを生成し、ポート等を改変する
- Q: 同時稼働環境数の設計上限は？ → A: 最大 10 環境
- Q: プロジェクトの公開形態は？ → A: オープンソースとして公開する
- Q: 実装言語は？ → A: Go 言語。オーナーが Go に不慣れなため、コードコメントは詳細に記述する
- Q: 対象プラットフォームは？ → A: macOS、Linux、Windows の3プラットフォーム。Windows は WinGet で配布する

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - ワークツリー環境の作成 (優先度: P1)

開発者として、既存のプロジェクトから新しい Git ワークツリーを作成し、
そのワークツリー専用の Dev Container 環境一式を自動的に起動したい。
これにより、メインブランチの開発環境を中断することなく、
コーディングエージェント（Claude Code 等）に別ブランチの作業を任せられる。

**この優先度の理由**: ツールの最も基本的な価値提供であり、これがなければ
他のすべての機能が意味を持たない。単独で MVP として成立する。

**独立テスト**: devcontainer.json を持つ任意のプロジェクトで
コマンドを実行し、新しいワークツリーとコンテナセットが起動し、
既存環境と干渉しないことを確認する。

**受入シナリオ**:

1. **Given** devcontainer.json を含む Git リポジトリにいる、
   **When** `worktree-container create feature-branch` を実行する、
   **Then** 新しい Git ワークツリーが作成され、そのワークツリー専用の
   Dev Container 環境一式が起動し、既存環境とポート衝突が発生しない

2. **Given** Docker Compose ベースの devcontainer.json を持つプロジェクト
   （例: アプリ + DB + Redis の3コンテナ構成）、
   **When** ワークツリー環境を作成する、
   **Then** 3コンテナすべてが新規ワークツリー用に複製起動され、
   各コンテナが正常に通信できる

3. **Given** 既にワークツリー環境が1つ稼働中、
   **When** 2つ目のワークツリー環境を作成する、
   **Then** 2つの環境が完全に独立して同時稼働し、
   ポートやボリュームの競合が一切発生しない

---

### ユーザーストーリー 2 - ポートの自動管理 (優先度: P2)

開発者として、複数のワークツリー環境を同時に使う際に、
ポート番号を手動で管理したくない。システムがすべてのポート割り当てを
自動的に処理し、衝突を防いでほしい。

**この優先度の理由**: ポート衝突は手動管理で最も頻発する問題であり、
自動化しなければツールの利便性が大幅に低下する。
憲法原則 III（ポート衝突ゼロ）の中核実装。

**独立テスト**: 同一プロジェクトで3つのワークツリー環境を同時に作成し、
すべてのサービスがポート衝突なくアクセス可能であることを確認する。

**受入シナリオ**:

1. **Given** ポート 3000, 5432, 6379 を使う devcontainer.json がある、
   **When** 3つのワークツリー環境を順次作成する、
   **Then** 各環境のサービスにアクセスでき、
   ユーザーはポート番号を意識する必要がない

2. **Given** 複数のワークツリー環境が稼働中、
   **When** 各環境のサービスにアクセスしたい、
   **Then** `worktree-container list` でアクセス先情報が一覧表示され、
   どの環境のどのサービスに接続すればよいか明確にわかる

3. **Given** ワークツリー環境 A が稼働中にポート 3000 を使用している、
   **When** 同じポートを必要とするワークツリー環境 B を作成する、
   **Then** 環境 B は衝突しない代替ポートまたはプロキシ経由の
   アクセス手段を自動的に割り当てられる

---

### ユーザーストーリー 3 - ワークツリー環境のライフサイクル管理 (優先度: P3)

開発者として、不要になったワークツリー環境を簡単に停止・削除し、
現在の環境一覧を確認したい。リソース（コンテナ、ネットワーク、ボリューム）
が適切にクリーンアップされることを期待する。

**この優先度の理由**: 環境の作成だけでなく、管理と片付けがなければ
リソースが際限なく消費される。日常的な運用に不可欠。

**独立テスト**: ワークツリー環境を作成・一覧表示・停止・削除し、
各操作後にリソースの状態が期待通りであることを確認する。

**受入シナリオ**:

1. **Given** 複数のワークツリー環境が存在する、
   **When** `worktree-container list` を実行する、
   **Then** 各環境の名前、ブランチ、ステータス（稼働中/停止中）、
   使用中のサービスとアクセス先情報が一覧表示される

2. **Given** 稼働中のワークツリー環境がある、
   **When** `worktree-container stop <name>` を実行する、
   **Then** その環境のコンテナがすべて停止し、
   割り当てられていたポートが解放される

3. **Given** 停止中のワークツリー環境がある、
   **When** `worktree-container remove <name>` を実行する、
   **Then** コンテナ、ネットワーク、ワークツリー専用ボリュームが削除され、
   Git ワークツリーも削除される（ユーザー確認後）

4. **Given** 停止中のワークツリー環境がある、
   **When** `worktree-container start <name>` を実行する、
   **Then** その環境のコンテナがすべて再起動し、
   以前と同じ設定でサービスが利用可能になる

---

### ユーザーストーリー 4 - 複数 Dev Container ツールへの対応 (優先度: P4)

開発者として、VS Code の Dev Container 拡張機能だけでなく、
Dev Container CLI や DevPod を使ってワークツリー環境にアクセスしたい。

**この優先度の理由**: コーディングエージェントは VS Code を使わずに
Dev Container CLI でコンテナに接続するケースが多い。
DevPod はクラウド環境への拡張も可能にする。
ただし、基本機能（P1-P3）が安定してから対応すべき。

**独立テスト**: 同一ワークツリー環境に対して VS Code、
Dev Container CLI、DevPod のそれぞれで接続できることを確認する。

**受入シナリオ**:

1. **Given** ワークツリー環境が作成済み、
   **When** `devcontainer open` コマンドで接続を試みる、
   **Then** Dev Container CLI 経由で正常にコンテナに接続できる

2. **Given** ワークツリー環境が作成済み、
   **When** VS Code の「Reopen in Container」で接続を試みる、
   **Then** VS Code Dev Container 拡張で正常にコンテナに接続できる

3. **Given** ワークツリー環境が作成済み、
   **When** DevPod で接続を試みる、
   **Then** DevPod 経由で正常にコンテナに接続できる

---

### エッジケース

- 既にポートが使用されている状態（本ツール外のプロセスによる占有）で
  ワークツリー環境を作成しようとした場合、どう振る舞うか？
  → 使用中のポートを検出し、回避して割り当てる
- devcontainer.json が存在しないリポジトリで実行した場合どうなるか？
  → 明確なエラーメッセージを表示して終了する
- Docker デーモンが起動していない状態で実行した場合どうなるか？
  → Docker の起動を促すエラーメッセージを表示する
- ディスク容量が不足している状態でコンテナを作成しようとした場合は？
  → Docker のエラーを適切にハンドリングし、原因を伝えるメッセージを表示する
- ワークツリー環境の作成中にプロセスが中断された場合は？
  → 中間状態のリソースを検出し、クリーンアップまたは再開できるようにする
- Git ワークツリーが手動で削除された場合にコンテナはどうなるか？
  → `list` コマンドで孤立した環境を検出し、クリーンアップを提案する

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは既存の Git リポジトリから新しいワークツリーを作成し、
  そのワークツリー専用の Dev Container 環境を起動できなければならない（MUST）
- **FR-002**: システムはワークツリー環境間でポートが衝突しないことを
  保証しなければならない（MUST）
- **FR-003**: システムはすべてのポート割り当てを自動的に処理し、
  ユーザーがポート番号を手動で指定する必要をなくさなければならない（MUST）
- **FR-004**: システムは devcontainer.json（単一コンテナおよび
  Docker Compose ベース）を解析し、ワークツリーごとに適切な設定を
  生成できなければならない（MUST）
- **FR-005**: システムはワークツリー環境の一覧表示、停止、再起動、
  削除の各操作を提供しなければならない（MUST）
- **FR-006**: システムは環境削除時にコンテナ、ネットワーク、
  関連ボリュームを適切にクリーンアップしなければならない（MUST）
- **FR-007**: システムは VS Code Dev Container、Dev Container CLI、
  DevPod のいずれからでも接続可能な環境を生成しなければならない（MUST）
- **FR-008**: システムは各プラットフォームの主要パッケージマネージャで
  インストール可能でなければならない（MUST）。macOS / Linux は Homebrew
  （`brew install`）、Windows は WinGet（`winget install`）で配布する
- **FR-009**: システムは人間可読形式と JSON 形式の両方で出力を
  提供しなければならない（MUST）
- **FR-010**: システムは本ツール外のプロセスが使用中のポートも検出し、
  衝突を回避しなければならない（MUST）
- **FR-011**: システムはワークツリー環境の状態を Docker コンテナの
  ラベル/メタデータから動的に検出しなければならない（MUST）。
  外部状態ファイルへの依存は不要とする
- **FR-012**: システムは元プロジェクトの devcontainer.json を
  変更してはならない（MUST NOT）。ワークツリー側にコピーを生成し、
  ポートマッピング等の改変はコピーに対してのみ行う
- **FR-013**: システムは同一マシン上で最大 10 のワークツリー環境の
  同時稼働をサポートしなければならない（MUST）
- **FR-014**: システムはオープンソースソフトウェアとして公開しなければ
  ならない（MUST）。適切なライセンス（MIT, Apache 2.0 等）を選定し、
  README.md にインストール方法・使い方・コントリビューション方法を
  記載しなければならない（MUST）
- **FR-015**: ソースコードにはすべての公開関数・型・定数および
  主要な非公開関数に対して、処理の意図と動作を説明する詳細な
  コメントを記述しなければならない（MUST）。Go 言語固有のイディオムを
  使用する箇所では、そのパターンの目的も説明しなければならない（MUST）

### 主要エンティティ

- **ワークツリー環境（WorktreeEnv）**: Git ワークツリーと紐づいた
  Dev Container 環境のセット。ブランチ名、ワークツリーパス、
  ステータス（稼働中/停止中）、割り当てポート情報を持つ。
  状態は Docker コンテナのラベル/メタデータから動的に検出し、
  外部状態ファイルは使用しない
- **ポート割り当て（PortAllocation）**: ワークツリー環境ごとの
  ポートマッピング。元のポート番号と実際に割り当てられたポート番号
  （またはプロキシルート）の対応関係。Docker コンテナラベルに記録される
- **Dev Container 設定（DevContainerConfig）**: 元の devcontainer.json
  から派生したワークツリー固有の設定。コンテナ定義、ポートマッピング、
  マウント設定、環境変数を含む。元の devcontainer.json は読み取り専用とし、
  ワークツリー側にコピーを生成して改変する

## 前提事項

- ユーザーのマシンに Docker Engine または Docker Desktop がインストール済み
- ユーザーのマシンに Git >= 2.15 がインストール済み
- 対象プロジェクトのルートに `.devcontainer/devcontainer.json` が存在する
- macOS、Linux、Windows を対象プラットフォームとする
- ポート管理の具体的方式（リバースプロキシ vs ポートシフト）は
  実装計画フェーズで決定する
- 実装言語は Go を採用する（計画フェーズで選定済み）
- プロジェクトはオープンソースとして公開する
- プロジェクトオーナーは Go 言語に不慣れであるため、
  コードの可読性とコメントの充実度を重視する

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーは1つのコマンドで新しいワークツリー環境を
  作成・起動できる（操作開始から利用可能になるまで）
- **SC-002**: 同一マシン上で最大 10 のワークツリー環境を同時に
  稼働させてもポート衝突が発生しない
- **SC-003**: ユーザーがポート番号を1つも手動指定することなく、
  すべてのサービスにアクセスできる
- **SC-004**: ワークツリー環境の作成・停止・削除の各操作が
  1コマンドで完結する
- **SC-005**: 各プラットフォームのパッケージマネージャコマンドのみで
  ツールのインストールが完了する（macOS/Linux: `brew install`、
  Windows: `winget install`）
- **SC-006**: VS Code、Dev Container CLI、DevPod のいずれからでも
  作成された環境に接続できる
- **SC-007**: 環境削除後、関連するコンテナ・ネットワーク・ボリュームが
  残存しない（リソースリーク率 0%）
